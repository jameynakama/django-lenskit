<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI Query (Read-Only)</title>
    <style>
      body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 2rem; }
      h1 { font-size: 1.5rem; margin-bottom: 1rem; }
      textarea { width: 100%; min-height: 200px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; }
      .error { color: #b91c1c; margin: 0.5rem 0; }
      table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
      th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; }
      .hint { font-size: 0.9rem; color: #666; }
      code { background: #f7f7f7; padding: 0 4px; border-radius: 3px; }
      .orm { background: #f7f7f7; padding: 8px; border-radius: 4px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; white-space: pre-wrap;}
    </style>
  </head>
  <body>
    <h1>AI Query (Read-Only)</h1>

    {% if error %}<div class="error">{{ error }}</div>{% endif %}

    <div class="hint">
      Allowed models: <code>{{ allowed_models|join:", " }}</code>
    </div>

    <h2>Natural language</h2>
    <form method="post" action="{% url 'django_lenskit_ai_query:generate' %}" onsubmit="return false;">
      <label for="nl">Your query</label>
      <textarea id="nl" name="nl" placeholder="Show me the 10 most recent books with 'python' in the title"></textarea>
      <div style="margin-top: 0.75rem;">
        <button id="gen-btn">Generate DSL</button>
      </div>
    </form>
    <hr />
    <h2>JSON DSL (advanced)</h2>
    <form method="post">
      {% csrf_token %}
      <label for="dsl">JSON DSL</label>
      <textarea id="dsl" name="dsl" placeholder='{"model":"app.Model","fields":["id"],"filters":{},"exclude":{},"order_by":[],"limit":50}'>{{ dsl_text }}</textarea>
      <div style="margin-top: 0.75rem;">
        <button type="submit">Run</button>
      </div>
    </form>
    <script>
      (function() {
        function getCsrfToken() {
          var el = document.querySelector('input[name=csrfmiddlewaretoken]');
          if (el && el.value) return el.value;
          var m = document.cookie && document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/);
          return m ? decodeURIComponent(m[1]) : '';
        }
        // Restore and persist natural language input across page loads
        var nlElInit = document.getElementById('nl');
        if (nlElInit) {
          var saved = localStorage.getItem('lk_ai_nl') || '';
          if (saved && !nlElInit.value) nlElInit.value = saved;
          nlElInit.addEventListener('input', function() {
            localStorage.setItem('lk_ai_nl', nlElInit.value || '');
          });
        }
        // Ensure it's saved before the DSL "Run" form posts
        var dslElRef = document.getElementById('dsl');
        if (dslElRef && dslElRef.form) {
          dslElRef.form.addEventListener('submit', function() {
            var nlEl = document.getElementById('nl');
            if (nlEl) localStorage.setItem('lk_ai_nl', nlEl.value || '');
          });
        }
        var btn = document.getElementById('gen-btn');
        if (!btn) return;
        btn.addEventListener('click', async function(e) {
          e.preventDefault();
          var nlEl = document.getElementById('nl');
          var dslEl = document.getElementById('dsl');
          if (!nlEl || !dslEl) return;
          var q = nlEl.value;
          if (!q) return;
          localStorage.setItem('lk_ai_nl', q || '');
          try {
            var resp = await fetch("{% url 'django_lenskit_ai_query:generate' %}", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCsrfToken()
              },
              body: JSON.stringify({ query: q })
            });
            var data = await resp.json();
            if (data && data.dsl) {
              dslEl.value = JSON.stringify(data.dsl, null, 2);
            } else {
              alert((data && data.error) || "Failed to generate DSL");
            }
          } catch (err) {
            alert("Error generating DSL: " + err);
          }
        });
      })();
    </script>

    {% if orm %}
      <h2>ORM</h2>
      <div class="orm">{{ orm }}</div>
    {% endif %}

    {% if rows %}
      <h2>Results</h2>
      <table>
        <thead>
          {% if rows.0 %}
            <tr>
              {% for k, v in rows.0.items %}
                {% if k != 'admin_url' %}<th>{{ k }}</th>{% endif %}
              {% endfor %}
            </tr>
          {% endif %}
        </thead>
        <tbody>
          {% for r in rows %}
            <tr>
              {% for k, v in r.items %}
                {% if k != 'admin_url' %}
                  {% if r.admin_url %}
                    {% if k == 'pk' or k == pk_field %}
                      <td><a href="{{ r.admin_url }}">{{ v }}</a></td>
                    {% else %}
                      <td>{{ v }}</td>
                    {% endif %}
                  {% else %}
                    <td>{{ v }}</td>
                  {% endif %}
                {% endif %}
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </body>
  </html>
